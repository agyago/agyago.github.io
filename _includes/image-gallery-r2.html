<!-- Image Gallery - R2 Version -->
<!-- Loads photos from Cloudflare R2 via API -->

<script type="text/javascript" src="{{ '/js/lightbox.js' | relative_url }}"></script>
<link rel="stylesheet" href="{{ '/css/lightbox.css' | relative_url }}">
<link rel="stylesheet" href="{{ '/css/likes.css' | relative_url }}">

<style>
  .gallery-loading {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  .gallery-error {
    text-align: center;
    padding: 40px;
    color: #d32f2f;
    background: #ffebee;
    border-radius: 8px;
    margin: 20px 0;
  }
</style>

<div id="gallery-container">
  <div class="gallery-loading">
    <p>Loading photos...</p>
  </div>
</div>

<ul class="image-gallery" id="gallery-grid" style="display: none;">
  <!-- Photos will be loaded here dynamically -->
</ul>

<script>
  (async function loadGallery() {
    const container = document.getElementById('gallery-container');
    const grid = document.getElementById('gallery-grid');

    try {
      // Fetch photo list from API
      const response = await fetch('/api/photos?metadata=true');

      if (!response.ok) {
        throw new Error('Failed to load photos');
      }

      const data = await response.json();
      const photos = data.photos || [];

      if (photos.length === 0) {
        container.innerHTML = '<div class="gallery-loading"><p>No photos yet. <a href="/upload">Upload some!</a></p></div>';
        return;
      }

      // Photo server URL (will be configured via Cloudflare)
      // Option 1: Use weserv.nl for resizing (free, your current approach)
      // Option 2: Use direct R2 URLs (if we pre-generate thumbnails)
      const PHOTO_SERVER = 'https://photos.cheezychinito.com'; // Your Worker URL

      // Clear loading message
      container.style.display = 'none';
      grid.style.display = '';

      // Render each photo
      photos.forEach(photo => {
        const filename = photo.filename || photo;
        const cleanName = filename
          .replace(/\.[^/.]+$/, '') // Remove extension
          .replace(/[-_]/g, ' ')    // Replace dashes/underscores with spaces
          .replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.substr(1).toLowerCase()); // Capitalize

        const li = document.createElement('li');
        li.className = 'gallery-item';

        // Use weserv.nl for both thumbnail and full size (FREE)
        const thumbUrl = `//images.weserv.nl/?url=${PHOTO_SERVER}/${filename}?size=full&w=300&h=300&output=jpg&q=50&t=square`;
        const fullUrl = `//images.weserv.nl/?url=${PHOTO_SERVER}/${filename}?size=full&w=2000&output=jpg&q=85`;

        // Option 2: If pre-generating thumbnails, use direct URLs:
        // const thumbUrl = `${PHOTO_SERVER}/${filename}?size=thumb`;
        // const fullUrl = `${PHOTO_SERVER}/${filename}?size=full`;

        li.innerHTML = `
          <a href="${fullUrl}"
             class="lightbox-image"
             title="${cleanName}"
             data-photo="${filename}"
             data-lightbox="gallery-r2"
             data-title="${cleanName}">
            <img src="${thumbUrl}"
                 alt="Image: ${cleanName}"
                 loading="lazy" />
          </a>
        `;

        grid.appendChild(li);
      });

      // Manually attach lightbox click handlers to dynamically added links
      const lightboxLinks = grid.querySelectorAll('a.lightbox-image');
      lightboxLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const photoName = this.getAttribute('data-photo') || '';

          // Create lightbox HTML (same as lightbox.js does)
          document.getElementById('lightbox').innerHTML = '<a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="img" style="background: url(\''+this.getAttribute('href')+'\') center center / contain no-repeat;" title="'+this.getAttribute('title')+'" ><img src="'+this.getAttribute('href')+'" alt="'+this.getAttribute('title')+'" /></div><span>'+this.getAttribute('title')+'</span><div class="lightbox-likes" data-photo="'+photoName+'"><button class="like-button" onclick="event.stopPropagation(); toggleLike(\''+photoName+'\', this)" aria-label="Like photo"><span class="heart">ü§ç</span><span class="like-count">0</span></button></div>';
          document.getElementById('lightbox').style.display = 'block';

          // Call setGallery to enable prev/next navigation
          if (typeof setGallery === 'function') {
            setGallery(this);
          }

          // Load like status
          if(photoName && typeof loadLikeStatus === 'function') {
            const likeDiv = document.querySelector('.lightbox-likes');
            loadLikeStatus(photoName, likeDiv);
          }
        });
      });

      console.log(`Loaded ${photos.length} photos from R2`);

    } catch (error) {
      console.error('Gallery loading error:', error);
      container.innerHTML = `
        <div class="gallery-error">
          <p><strong>Failed to load gallery</strong></p>
          <p>Please try refreshing the page.</p>
        </div>
      `;
    }
  })();
</script>

<script src="{{ '/js/likes.js' | relative_url }}"></script>
