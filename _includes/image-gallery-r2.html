<!-- Image Gallery - R2 Version -->
<!-- Loads photos from Cloudflare R2 via API -->

<script type="text/javascript" src="{{ '/js/lightbox.js' | relative_url }}"></script>
<link rel="stylesheet" href="{{ '/css/lightbox.css' | relative_url }}">
<link rel="stylesheet" href="{{ '/css/likes.css' | relative_url }}">

<style>
  .gallery-loading {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  .gallery-error {
    text-align: center;
    padding: 40px;
    color: #d32f2f;
    background: #ffebee;
    border-radius: 8px;
    margin: 20px 0;
  }
</style>

<div id="gallery-container">
  <div class="gallery-loading">
    <p>Loading photos...</p>
  </div>
</div>

<ul class="image-gallery" id="gallery-grid" style="display: none;">
  <!-- Photos will be loaded here dynamically -->
</ul>

<script>
  (async function loadGallery() {
    const container = document.getElementById('gallery-container');
    const grid = document.getElementById('gallery-grid');

    // Security: Escape HTML special characters to prevent XSS
    function escapeHtmlAttr(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;')
                 .replace(/"/g, '&quot;')
                 .replace(/'/g, '&#39;')
                 .replace(/</g, '&lt;')
                 .replace(/>/g, '&gt;');
    }

    // Security: Escape for use in CSS url()
    function escapeUrlForCss(url) {
      if (!url) return '';
      return encodeURI(url).replace(/'/g, '%27').replace(/"/g, '%22');
    }

    try {
      // Fetch photo list from API
      const response = await fetch('/api/photos?metadata=true');

      if (!response.ok) {
        throw new Error('Failed to load photos');
      }

      const data = await response.json();
      const photos = data.photos || [];

      if (photos.length === 0) {
        container.innerHTML = '<div class="gallery-loading"><p>No photos yet. <a href="/upload">Upload some!</a></p></div>';
        return;
      }

      // Photo server URL (will be configured via Cloudflare)
      const PHOTO_SERVER = 'https://photos.cheezychinito.com';

      // Clear loading message
      container.style.display = 'none';
      grid.style.display = '';

      // Render each photo using safe DOM methods
      photos.forEach(photo => {
        const filename = photo.filename || photo;
        const cleanName = filename
          .replace(/\.[^/.]+$/, '') // Remove extension
          .replace(/[-_]/g, ' ')    // Replace dashes/underscores with spaces
          .replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.substr(1).toLowerCase()); // Capitalize

        const li = document.createElement('li');
        li.className = 'gallery-item';

        // Use weserv.nl for both thumbnail and full size (FREE)
        const thumbUrl = `//images.weserv.nl/?url=${PHOTO_SERVER}/${encodeURIComponent(filename)}?size=full&v=2&w=300&h=300&output=jpg&q=50&t=square`;
        const fullUrl = `//images.weserv.nl/?url=${PHOTO_SERVER}/${encodeURIComponent(filename)}?size=full&v=2&w=2000&output=jpg&q=85`;

        // Create anchor element safely
        const a = document.createElement('a');
        a.href = fullUrl;
        a.className = 'lightbox-image';
        a.title = cleanName;
        a.setAttribute('data-photo', filename);
        a.setAttribute('data-lightbox', 'gallery-r2');
        a.setAttribute('data-title', cleanName);

        // Create image element safely
        const img = document.createElement('img');
        img.src = thumbUrl;
        img.alt = 'Image: ' + cleanName;
        img.loading = 'lazy';

        a.appendChild(img);
        li.appendChild(a);
        grid.appendChild(li);
      });

      // Manually attach lightbox click handlers to dynamically added links
      const lightboxLinks = grid.querySelectorAll('a.lightbox-image');
      lightboxLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const photoName = this.getAttribute('data-photo') || '';
          const href = this.getAttribute('href');
          const title = this.getAttribute('title');

          // Create lightbox elements safely using DOM methods
          const lightbox = document.getElementById('lightbox');
          lightbox.innerHTML = '';

          // Create close button
          const closeBtn = document.createElement('a');
          closeBtn.id = 'close';
          lightbox.appendChild(closeBtn);

          // Create next button
          const nextBtn = document.createElement('a');
          nextBtn.id = 'next';
          nextBtn.innerHTML = '&rsaquo;';
          lightbox.appendChild(nextBtn);

          // Create prev button
          const prevBtn = document.createElement('a');
          prevBtn.id = 'prev';
          prevBtn.innerHTML = '&lsaquo;';
          lightbox.appendChild(prevBtn);

          // Create image container
          const imgDiv = document.createElement('div');
          imgDiv.className = 'img';
          imgDiv.style.background = "url('" + escapeUrlForCss(href) + "') center center / contain no-repeat";
          imgDiv.title = title;

          const imgEl = document.createElement('img');
          imgEl.src = href;
          imgEl.alt = title;
          imgDiv.appendChild(imgEl);
          lightbox.appendChild(imgDiv);

          // Create title span
          const titleSpan = document.createElement('span');
          titleSpan.textContent = title;
          lightbox.appendChild(titleSpan);

          // Create likes section
          const likesDiv = document.createElement('div');
          likesDiv.className = 'lightbox-likes';
          likesDiv.setAttribute('data-photo', photoName);

          const likeBtn = document.createElement('button');
          likeBtn.className = 'like-button';
          likeBtn.setAttribute('aria-label', 'Like photo');
          // Use addEventListener instead of inline onclick (safer)
          likeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (typeof toggleLike === 'function') {
              toggleLike(photoName, this);
            }
          });

          const heartSpan = document.createElement('span');
          heartSpan.className = 'heart';
          heartSpan.textContent = 'ü§ç';
          likeBtn.appendChild(heartSpan);

          const countSpan = document.createElement('span');
          countSpan.className = 'like-count';
          countSpan.textContent = '0';
          likeBtn.appendChild(countSpan);

          likesDiv.appendChild(likeBtn);
          lightbox.appendChild(likesDiv);

          lightbox.style.display = 'block';

          // Call setGallery to enable prev/next navigation
          if (typeof setGallery === 'function') {
            setGallery(this);
          }

          // Load like status
          if(photoName && typeof loadLikeStatus === 'function') {
            loadLikeStatus(photoName, likesDiv);
          }
        });
      });

      console.log(`Loaded ${photos.length} photos from R2`);

    } catch (error) {
      console.error('Gallery loading error:', error);
      container.innerHTML = `
        <div class="gallery-error">
          <p><strong>Failed to load gallery</strong></p>
          <p>Please try refreshing the page.</p>
        </div>
      `;
    }
  })();
</script>

<script src="{{ '/js/likes.js' | relative_url }}"></script>
